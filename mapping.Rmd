---
title: "Mapping Species Occurrences"
output: pdf_document
---

## Mapping Species Occurrences

Spidertail
Mapping Species Occurrences 
Feburary 15th 

There are two big goals of today's R Notebook:

* Practicing the integration of GitHub into your workflow. 
* Diving deeper into using R to map species distribution.  

DUE BY NEXT MONDAY: a jpg image of your species distribution map.


Setup instructions for your reference: https://docs.google.com/document/d/1EO5AH3AczU-ruHLnvZ9Nz7yn8NaSfwgzHYyqKi4ZYXY/edit?usp=sharing


```{r}
# load packages:

library("spocc")
library("sp")
library("raster")
library("maptools")
library("rgdal")
library("dismo")
library("sf")

library("tidyverse")

```




### GitHub integration


Workflow:
* write some code (typically some sort of project-oriented goal)
* commit. 
* push.
* pull (if you need to get the latest pushed code from github)
* Use Slack to communicate! (e.g. "ok, I just pushed to github, go ahead and pull)

Check out commit-push-pull.jpg for a visual representation.

How to Commit (i.e. selecting files to synch to GitHub): 
* Save any files you've been editing toward your "commit" goal.
* In the upper-right window, open the Git tab. 
* Click the checkboxes next to any files to be included in your commit.
* Click "Commit"
* A window will open. Write a description of your commit in the "Commit Message" box, and click "Commit".
* Close the resulting window. 

How to Push (i.e. synch the files to GitHub): 
* Immediately after you've committed, you'll want to push.  
* In the window that had opened from your commit, click Push (next to green up arrow)
* A window will pop up with a message, which you can close.
* IF you're asked for a password, highlight and run the code in github.R, and try pushing again.

How to Pull (i.e. get the latest changes in GitHub into your rstudio.cloud environment):
* In the Git tab, click the down-pointing green arrow.

BEWARE: Things can get really messy if you and your groupmates are simultaneously working on the same file(s), and committing-pushing-pulling. For now, it's best to communicate, and take turns. If you run into problems, don't fret...we've all been there. Reach out to us on Slack, and we can help things get squared away.





Practice:

Group member 1: Dharma
* write code in the code chunk below to query milkweed species from GBIF
* Commit
* Push
* Tell your groupmates to pull in Slack

```{r}
# I had to run install.packages("sf") in the counsole
horsetail <- occ(query='Asclepias subverticillata', from='gbif', limit=1000)
horsetail
```


Group member 2: Roland
* write code in the code chunk below to query milkweed species from GBIF
* Commit
* Push
* Tell your groupmates to pull in Slack

```{r}

# Like Dharma, I also had to run install.packages("sf") in the console
# I also pulled the Arizona specific data and adjusted the limit accordingly

horsetailAZ <- occ(query='Asclepias subverticillata', from='gbif', gbifopts = list(stateProvince="Arizona"), limit=1000)
horsetailAZ

```


Group member 3: Sammy
* write code in the code chunk below to query milkweed species from GBIF
* Commit
* Push
* Tell your groupmates to pull in Slack

```{r}
# I also had to run install.packages("sf") the first time
# I copied code from above to double check it worked, but edited to return all values
horsetail <- occ(query='Asclepias subverticillata', from='gbif', limit=3000)
horsetail

```

Group member 4: Christopher Olson
* write code in the code chunk below to query milkweed species from GBIF
* Commit
* Push
* Tell your groupmates to pull in Slack

```{r}
Tophershorsetaildata <-occ(query='Asclepias subverticillata', from='gbif', limit=3000)
Tophershorsetaildata
#removing an object I made called 'horsetaildata' because it was confusingly similar to 'horsetailData' which we're actually using
rm(horsetaildata)

```


### Data cleaning


Just like in the last exercise, it's important to look for errors in the data.
Check here for a refresher: https://github.com/BiodiversityDataScienceCorp/more-querying-gbif-data/blob/main/more-querying-gbif.Rmd

Group Member 1: Dharma

Check for and filter out any data in which occurrenceStatus=="Absent"
* write code below
* Commit
* Push
* Tell your groupmates to pull in Slack

```{r}
# first view the data 
horsetailData = horsetail$gbif$data$Asclepias_subverticillata
horsetailData
```
```{r}
# next remove absent. note code is from previous assignment

# check if there are any
unique(horsetailData$occurrenceStatus)

# there are, so remove them
absent <- subset(x=horsetailData, occurrenceStatus !="PRESENT")
absent

# note anti_join is in the tidyverse, it was not originally called
horsetailData <- anti_join(horsetailData, absent)
horsetailData
```


Group Member 2: Roland

Check for and filter out any occurrences in which individualCount==0
* write code below
* Commit
* Push
* Tell your groupmates to pull in Slack

```{r}
# Code taken from more-querying-gbif-data assignment

# First - check if there are any
unique(horsetailData$individualCount)

# There aren't any I found where individualCount==0, but here is the code that would theoretically do this

zeroHorsetail<-subset(horsetailData, individualCount==0)

horsetailData<-anti_join(horsetailData, zeroHorsetail)

# And here is code that removes rows where individualCount==NA

NAHorsetail<-subset(horsetailData, is.na(individualCount))

horsetailData<-anti_join(horsetailData, NAHorsetail)

horsetailData

```


Group Member 3: Sammy

Check for obvious errors in lat/long. Remove those points if necessary.
* write code below
* Commit
* Push
* Tell your groupmates to pull in Slack
```{r}
# removing rows where latitude==NA (where latitude==NA, longitude==NA so I only used latitude)
NALat<-subset(horsetailData, is.na(latitude))
horsetailData<-anti_join(horsetailData, NALat)
horsetailData

# plot data to see if anything seemed off
wm <- borders("world", colour="gray50", fill="gray50")
ggplot()+ coord_fixed()+ wm +
  geom_point(data = horsetailData, aes(x = longitude, y = latitude),
             colour = "darkred", size = 1.0)+
  theme_bw()
# Nothing seemed out of reasonable range, although not all data lied within Arizona

# by looking through the coordinate data after removing NA's, I did not see any other erroneous data points with missing or out of place '-' signs, or values that seemed absurdly small or large
```

Group Member 4 (or 1): Christopher Olson

Reduce data columns, and save to a CSV file
* write code below
* Commit
* Push
* Tell your groupmates to pull in Slack
NOTE: Depending upon the size of your .csv file, you may not want to commit and push it. Your groupmates can always re-run the code to generate their own local copy.
```{r}
# Reduce Data Columns

#here I list the columns I think we should keep, and create a reduced data set
reducedhorsetailData<-select(horsetailData, c(name, longitude, latitude, stateProvince, year, month, day, eventDate, individualCount))

reducedhorsetailData

#now I make a csv file. Sammy hasn't yet cleaned out the NA lat/long rows, so I won't do it yet. Here's the code we'll use

write_csv(reducedhorsetailData, "reducedhorsetail.csv")
```
### Mapping

We did a little bit of mapping in the last assignment, when we were checking for erroneous points. Now let's try to make a more fine-tuned map of species occurrences, with the goal of creating ans image you could use in your final report.

There are numerous ways to create a map in R. We're going to look at one method here, but don't feel restricted if you want to try a different technique. Searching in Google is an effective way to learn about alternatives.

Let's look at an example using the Goldfinch data.

First we want to load the data set:

```{r}
goldfinches<-read_csv("goldfinchOr.csv")
goldfinches
```


Now let's determine the minimum and maximum latitudes and longitudes of the data set. This will help us define where to focus the map. We want our boundaries to be slightly larger than all points contained:

```{r}

# ceiling returns the smallest integer that is greater than or equal to a value
# max gives the largest value of the column data
# so if the highest value in goldfinches$latitude is 46.5, then its ceiling is 47

max.lat <- ceiling(max(goldfinches$latitude))

# floor and min work similarly (but opposite)
# if the lowest value of goldfinches$latitude is 43.84, then its floor is 43

min.lat <- floor(min(goldfinches$latitude))

# run same calculations for longitude

max.lon <- ceiling(max(goldfinches$longitude))
min.lon <- floor(min(goldfinches$longitude))



```


Now these values are ready to use in the map code. 

In the sequence below, I'll first indicate that I want to save the output as a jpg. Then 


```{r}
# indicates that I want to save the next output as "or.jpg"
jpeg(file="or.jpg")

# this loads spatial polygons
data(wrld_simpl)

# Plot the base map
plot(wrld_simpl, 
     xlim = c(min.lon, max.lon), # sets upper/lower x
     ylim = c(min.lat, max.lat), # sets upper/lower y
     axes = TRUE, 
     col = "grey95",
     main="Goldfinch species occurrences in Oregon, 2020",  # a title
     sub="an informative caption" # a caption
     )

# Add the points for individual observation
points(x = goldfinches$longitude, 
       y = goldfinches$latitude, 
       col = "blue", 
       pch = 20, 
       cex = 0.75)
# And draw a little box around the graph
box()

# indicates I'm done with plotting and saving to jpg
dev.off()
```


Select a group member to create a map of your milkweed occurrence data. Follow the example above: first determine your min/max lat/lon, and then generate the map code. Save this as a jpg file. Then commit, and push to Github (and have your group members pull).

First read the csv
```{r}
horsetailFromCSV = read_csv("reducedhorsetail.csv")
horsetailFromCSV
```



```{r}
# find the boundaries for latitude and longitude
max.lat <- ceiling(max(horsetailFromCSV$latitude))

min.lat <- floor(min(horsetailFromCSV$latitude))

# run same calculations for longitude

max.lon <- ceiling(max(horsetailFromCSV$longitude))
min.lon <- floor(min(horsetailFromCSV$longitude))

```

```{r}
# now make the actual map
jpeg(file="map.jpg")

# loads spatial polygons
data(wrld_simpl)

# Plot the base map
plot(wrld_simpl, 
     xlim = c(min.lon, max.lon), # sets upper/lower x
     ylim = c(min.lat, max.lat), # sets upper/lower y
     axes = TRUE, 
     col = "grey95",
     main="Horsetail Milkweek Occurances",  # a title
     sub="an informative caption" # a caption
     )

# Add the points for individual observation
points(x = horsetailFromCSV$longitude, 
       y = horsetailFromCSV$latitude, 
       col = "lightpink3", 
       pch = 20, 
       cex = 0.75)
# And draw a little box around the graph
box()

# indicates I'm done with plotting and saving to jpg
dev.off()
```
```


Download your map jpg, and submit it to the assignment 5 folder. Name it in the format of "Assignment5_GroupName.jpg".  

Turn in the image to the Assignment 5 folder here: https://drive.google.com/drive/folders/1pJW4cqtamx_AvldgajF9SkhY9uxz32EW?usp=sharing
